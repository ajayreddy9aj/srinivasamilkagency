<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Milk Agency Sheet — Master Prices + Paid→Auto Due</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; background: #f5f5f5; }
    h2 { margin-top: 0; }
    table { width: 100%; border-collapse: collapse; background: #fff; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    th .priceHint { display:block; font-size:11px; color:#555; margin-top:2px; }
    td input { width: 100%; box-sizing: border-box; padding:3px; font-size:13px; }
    .nameCol input { width: 140px; }
    .mobileCol input { width: 120px; }
    .qtyInput { width: 55px; }
    .priceInput { width: 55px; }
    .dueHead { min-width: 110px; }
    .dueCol input { width: 110px; }
    .cellStack { display:flex; flex-direction:column; gap:2px; align-items:center; }
    .cellStack span { font-size:11px; color:#666; }
    .controls { margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .controls button, .controls input { padding:6px 10px; border-radius:4px; font-size:14px; }
    .addBtn { background:#16a34a; color:#fff; border:none; cursor:pointer; }
    .pdfBtn { background:#6b21a8; color:#fff; border:none; cursor:pointer; }
    .editBtn { background:#0ea5e9; color:#fff; border:none; cursor:pointer; padding:4px 8px; }
    .saveBtn { background:#22c55e; color:#fff; border:none; cursor:pointer; padding:4px 8px; }
    .cancelBtn { background:#f59e0b; color:#fff; border:none; cursor:pointer; padding:4px 8px; }
    .deleteBtn { background:#ef4444; color:#fff; border:none; cursor:pointer; padding:4px 8px; }
    .sendBtn { background:#10b981; color:#fff; border:none; cursor:pointer; padding:4px 8px; }
    .totalBox { background:#fff; margin-top:14px; padding:12px; border-radius:6px; font-size:14px; line-height:1.4; }
    .masterPrices { background:#fff; padding:8px; border-radius:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .masterPrices label { font-size:13px; color:#333; }
    .masterPrices input { width:72px; padding:6px; border:1px solid #ccc; border-radius:4px; }
    .no-print { }
    @media print { .no-print { display:none !important; } body { background:#fff; padding:0; } }
  </style>
</head>
<body>

<div class="no-print controls">
  <h2>Milk Agency Sheet</h2>

  <label>Date:
    <input type="date" id="datePicker">
  </label>

  <button class="addBtn" id="addRowBtn">+ Add Customer</button>
  <button class="pdfBtn" id="pdfBtn">Save / Print PDF</button>
</div>

<!-- MASTER PRICES -->
<div class="no-print masterPrices" style="margin-bottom:10px;">
  <strong>Master Prices (Edit & Save)</strong>
  <label>TM <input id="master_tm" type="number" step="0.01"></label>
  <label>S Milk <input id="master_sMilk" type="number" step="0.01"></label>
  <label>S Curd <input id="master_sCurd" type="number" step="0.01"></label>
  <label>B Curd <input id="master_bCurd" type="number" step="0.01"></label>
  <label>H500 <input id="master_h500" type="number" step="0.01"></label>
  <label>FM <input id="master_fm" type="number" step="0.01"></label>
  <label>FM1L <input id="master_fm1l" type="number" step="0.01"></label>
  <label>SM1L <input id="master_sm1l" type="number" step="0.01"></label>

  <button id="saveMaster" class="saveBtn">Save Master</button>
  <button id="resetMaster" class="cancelBtn">Reset to Default</button>
</div>

<table id="sheet">
  <thead>
    <tr>
      <th>Name</th>
      <th>Mobile</th>
      <th>TM <span class="priceHint" id="hint_tm">₹56/L</span></th>
      <th>S Milk <span class="priceHint" id="hint_sMilk">₹45/L</span></th>
      <th>S Curd <span class="priceHint" id="hint_sCurd">₹45/L</span></th>
      <th>B Curd <span class="priceHint" id="hint_bCurd">₹68/L</span></th>
      <th>H500 <span class="priceHint" id="hint_h500">₹86/L</span></th>
      <th>FM <span class="priceHint" id="hint_fm">₹77/L</span></th>
      <th>FM1L <span class="priceHint" id="hint_fm1l">₹73/L</span></th>
      <th>SM1L <span class="priceHint" id="hint_sm1l">₹66/L</span></th>
      <th>Total Litres</th>
      <th>Total Amount</th>
      <th>Paid (EDIT)</th>
      <th class="dueHead">Due (AUTO)</th>
      <th class="no-print">Send</th>
      <th class="no-print">Edit / Save</th>
      <th class="no-print">Delete</th>
    </tr>
  </thead>

  <tbody id="body"></tbody>
</table>

<div class="totalBox">
  <p>Total TM: <span id="tTM">0</span> L</p>
  <p>Total S Milk: <span id="tSM">0</span> L</p>
  <p>Total S Curd: <span id="tSC">0</span> L</p>
  <p>Total B Curd: <span id="tBC">0</span> L</p>
  <p>Total H500: <span id="tH5">0</span> L</p>
  <p>Total FM: <span id="tFM">0</span> L</p>
  <p>Total FM1L: <span id="tFM1">0</span> L</p>
  <p>Total SM1L: <span id="tSM1">0</span> L</p>
  <p>Total Litres Sold: <span id="tLIT">0</span> L</p>
  <p>Total Money Received: ₹<span id="tMoney">0</span></p>
</div>

<script>
  // DEFAULT MASTER PRICES (used if no saved master)
  const DEFAULT_MASTER = {
    tm: 56,
    sMilk: 45,
    sCurd: 45,
    bCurd: 68,
    h500: 86,
    fm: 77,
    fm1l: 73,
    sm1l: 66
  };

  // load master from localStorage (persisted)
  function loadMaster() {
    const raw = localStorage.getItem("milkSheet_masterPrices");
    if (!raw) return {...DEFAULT_MASTER};
    try { return {...DEFAULT_MASTER, ...JSON.parse(raw)}; } catch(e) { return {...DEFAULT_MASTER}; }
  }
  function saveMaster(m) { localStorage.setItem("milkSheet_masterPrices", JSON.stringify(m)); }

  let MASTER = loadMaster();

  // expose hints + master inputs
  function refreshMasterUI() {
    document.getElementById("master_tm").value   = MASTER.tm;
    document.getElementById("master_sMilk").value= MASTER.sMilk;
    document.getElementById("master_sCurd").value= MASTER.sCurd;
    document.getElementById("master_bCurd").value= MASTER.bCurd;
    document.getElementById("master_h500").value = MASTER.h500;
    document.getElementById("master_fm").value    = MASTER.fm;
    document.getElementById("master_fm1l").value  = MASTER.fm1l;
    document.getElementById("master_sm1l").value  = MASTER.sm1l;

    document.getElementById("hint_tm").innerText   = `₹${MASTER.tm}/L`;
    document.getElementById("hint_sMilk").innerText= `₹${MASTER.sMilk}/L`;
    document.getElementById("hint_sCurd").innerText= `₹${MASTER.sCurd}/L`;
    document.getElementById("hint_bCurd").innerText= `₹${MASTER.bCurd}/L`;
    document.getElementById("hint_h500").innerText = `₹${MASTER.h500}/L`;
    document.getElementById("hint_fm").innerText    = `₹${MASTER.fm}/L`;
    document.getElementById("hint_fm1l").innerText  = `₹${MASTER.fm1l}/L`;
    document.getElementById("hint_sm1l").innerText  = `₹${MASTER.sm1l}/L`;
  }
  refreshMasterUI();

  // rows and date management
  let currentDateStr = null;
  let rows = [];

  function storageKey(dateStr) { return "milkSheet_" + dateStr; }

  // compute totals: NOTE: paid is editable, due is computed automatically
  function computeRowTotals(row) {
    const tmL    = parseFloat(row.tmL)    || 0;
    const sMilkL = parseFloat(row.sMilkL) || 0;
    const sCurdL = parseFloat(row.sCurdL) || 0;
    const bCurdL = parseFloat(row.bCurdL) || 0;
    const h500L  = parseFloat(row.h500L)  || 0;
    const fmL    = parseFloat(row.fmL)    || 0;
    const fm1lL  = parseFloat(row.fm1lL)  || 0;
    const sm1lL  = parseFloat(row.sm1lL)  || 0;

    const tmP    = parseFloat(row.tmPrice)    || MASTER.tm;
    const sMilkP = parseFloat(row.sMilkPrice) || MASTER.sMilk;
    const sCurdP = parseFloat(row.sCurdPrice) || MASTER.sCurd;
    const bCurdP = parseFloat(row.bCurdPrice) || MASTER.bCurd;
    const h500P  = parseFloat(row.h500Price)  || MASTER.h500;
    const fmP    = parseFloat(row.fmPrice)    || MASTER.fm;
    const fm1lP  = parseFloat(row.fm1lPrice)  || MASTER.fm1l;
    const sm1lP  = parseFloat(row.sm1lPrice)  || MASTER.sm1l;

    const totalLitres = tmL + sMilkL + sCurdL + bCurdL + h500L + fmL + fm1lL + sm1lL;

    const amount =
      tmL    * tmP    +
      sMilkL * sMilkP +
      sCurdL * sCurdP +
      bCurdL * bCurdP +
      h500L  * h500P  +
      fmL    * fmP    +
      fm1lL  * fm1lP  +
      sm1lL  * sm1lP;

    const prevDue = parseFloat(row.prevDue) || 0;
    // paid is editable by user now
    const rawPaid = (row.paid === undefined ? "" : row.paid);

    let paid = 0;
    if (rawPaid === "" || rawPaid === null) {
      paid = 0;
    } else {
      paid = parseFloat(rawPaid) || 0;
    }
    const due = prevDue + amount - paid;

    return { totalLitres, amount, paid, due, prevDue };
  }

  function saveCurrentDate() {
    if (!currentDateStr) return;
    localStorage.setItem(storageKey(currentDateStr), JSON.stringify(rows));
  }

  function loadDate(dateStr) {
    currentDateStr = dateStr;
    const key = storageKey(dateStr);
    const stored = localStorage.getItem(key);

    if (stored) {
      rows = JSON.parse(stored);
    } else {
      rows = buildFromPrevious(dateStr);
    }
    render();
  }

  // build rows for new date from previous date — carry prevDue forward
  function buildFromPrevious(dateStr) {
    const prefix = "milkSheet_";
    const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
    if (keys.length === 0) return [];

    const dates = keys
      .map(k => k.replace(prefix, ""))
      .filter(d => d < dateStr)
      .sort();

    if (dates.length === 0) return [];

    const prev = dates[dates.length - 1];
    const prevRows = JSON.parse(localStorage.getItem(storageKey(prev)) || "[]");

    return prevRows.map(r => {
      const totals = computeRowTotals(r);
      return {
        name: r.name || "",
        mobile: r.mobile || "",
        tmL: "",
        tmPrice: r.tmPrice || "",     // keep empty so MASTER is used unless per-customer set
        sMilkL: "",
        sMilkPrice: r.sMilkPrice || "",
        sCurdL: "",
        sCurdPrice: r.sCurdPrice || "",
        bCurdL: "",
        bCurdPrice: r.bCurdPrice || "",
        h500L: "",
        h500Price: r.h500Price || "",
        fmL: "",
        fmPrice: r.fmPrice || "",
        fm1lL: "",
        fm1lPrice: r.fm1lPrice || "",
        sm1lL: "",
        sm1lPrice: r.sm1lPrice || "",
        paid: "",        // user will enter paid for new date
        prevDue: totals.due,
        due: "",         // computed automatically
        edit: false
      };
    });
  }

  function addRow() {
    rows.push({
      name: "",
      mobile: "",
      tmL: "",
      tmPrice: "",
      sMilkL: "",
      sMilkPrice: "",
      sCurdL: "",
      sCurdPrice: "",
      bCurdL: "",
      bCurdPrice: "",
      h500L: "",
      h500Price: "",
      fmL: "",
      fmPrice: "",
      fm1lL: "",
      fm1lPrice: "",
      sm1lL: "",
      sm1lPrice: "",
      paid: "",
      prevDue: 0,
      due: "",
      edit: true
    });
    render();
  }

  function editRow(i) {
    rows[i].edit = true;
    render();
  }

  function cancelEdit(i) {
    rows[i].edit = false;
    render();
  }

  function deleteRow(i) {
    if (confirm("Delete this customer?")) {
      rows.splice(i, 1);
      render();
    }
  }

  function saveRow(i) {
    const r = rows[i];

    r.name   = document.getElementById("name_" + i).value.trim();
    r.mobile = document.getElementById("mobile_" + i).value.trim();

    r.tmL      = document.getElementById("tmL_" + i).value;
    r.tmPrice  = document.getElementById("tmP_" + i).value;

    r.sMilkL      = document.getElementById("sMilkL_" + i).value;
    r.sMilkPrice  = document.getElementById("sMilkP_" + i).value;

    r.sCurdL      = document.getElementById("sCurdL_" + i).value;
    r.sCurdPrice  = document.getElementById("sCurdP_" + i).value;

    r.bCurdL      = document.getElementById("bCurdL_" + i).value;
    r.bCurdPrice  = document.getElementById("bCurdP_" + i).value;

    r.h500L      = document.getElementById("h500L_" + i).value;
    r.h500Price  = document.getElementById("h500P_" + i).value;

    r.fmL      = document.getElementById("fmL_" + i).value;
    r.fmPrice  = document.getElementById("fmP_" + i).value;

    r.fm1lL      = document.getElementById("fm1lL_" + i).value;
    r.fm1lPrice  = document.getElementById("fm1lP_" + i).value;

    r.sm1lL      = document.getElementById("sm1lL_" + i).value;
    r.sm1lPrice  = document.getElementById("sm1lP_" + i).value;

    // Now capture Paid (user edits this) — Due will be auto-calculated
    r.paid = document.getElementById("paid_" + i).value;

    r.edit = false;
    render();
  }

  function sendInvoice(i) {
    const r = rows[i];
    const { totalLitres, amount, due, paid, prevDue } = computeRowTotals(r);

    if (!r.mobile) {
      alert("Please enter mobile number for this customer.");
      return;
    }

    // Clean mobile → digits only
    let mobile = (r.mobile || "").replace(/\D/g, "");
    if (mobile.length === 10) mobile = "91" + mobile;

    let msg = `Milk Bill - ${currentDateStr}\n`;
    msg += `Name: ${r.name || ""}\n`;
    msg += `Mobile: ${r.mobile || ""}\n\n`;
    msg += `Items:\n`;

    function line(label, litres, price) {
      const L = parseFloat(litres) || 0;
      const P = parseFloat(price) || 0;
      if (!L || !P) return "";
      const amt = L * P;
      return `• ${label}: ${L} L @ ₹${P} = ₹${amt}\n`;
    }

    msg += line("TM",    r.tmL,    r.tmPrice || MASTER.tm);
    msg += line("S Milk",r.sMilkL, r.sMilkPrice || MASTER.sMilk);
    msg += line("S Curd",r.sCurdL, r.sCurdPrice || MASTER.sCurd);
    msg += line("B Curd",r.bCurdL, r.bCurdPrice || MASTER.bCurd);
    msg += line("H500",  r.h500L,  r.h500Price || MASTER.h500);
    msg += line("FM",    r.fmL,    r.fmPrice || MASTER.fm);
    msg += line("FM1L",  r.fm1lL,  r.fm1lPrice || MASTER.fm1l);
    msg += line("SM1L",  r.sm1lL,  r.sm1lPrice || MASTER.sm1l);

    msg += `\nTotal litres today: ${totalLitres} L\n`;
    msg += `Today's amount: ₹${amount.toFixed(0)}\n`;
    msg += `Previous due: ₹${prevDue.toFixed(0)}\n`;
    msg += `Paid today: ₹${paid.toFixed(0)}\n`;
    msg += `Final due: ₹${due.toFixed(0)}\n`;

    const url = `https://wa.me/${mobile}?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");
  }

  function render() {
    const tbody = document.getElementById("body");
    tbody.innerHTML = "";

    let tTM = 0, tSM = 0, tSC = 0, tBC = 0, tH5 = 0, tFM = 0, tFM1 = 0, tSM1 = 0;
    let totalLitresSold = 0;
    let totalMoney = 0;

    rows.forEach((r, i) => {
      const { totalLitres, amount, due, paid } = computeRowTotals(r);

      tTM  += parseFloat(r.tmL)    || 0;
      tSM  += parseFloat(r.sMilkL) || 0;
      tSC  += parseFloat(r.sCurdL) || 0;
      tBC  += parseFloat(r.bCurdL) || 0;
      tH5  += parseFloat(r.h500L)  || 0;
      tFM  += parseFloat(r.fmL)    || 0;
      tFM1 += parseFloat(r.fm1lL)  || 0;
      tSM1 += parseFloat(r.sm1lL)  || 0;

      totalLitresSold += totalLitres;
      totalMoney += paid;

      const tr = document.createElement("tr");

      if (!r.edit) {
        tr.innerHTML = `
          <td>${r.name || ""}</td>
          <td>${r.mobile || ""}</td>

          <td>${r.tmL ? r.tmL + " L @ ₹" + (r.tmPrice || MASTER.tm) : ""}</td>
          <td>${r.sMilkL ? r.sMilkL + " L @ ₹" + (r.sMilkPrice || MASTER.sMilk) : ""}</td>
          <td>${r.sCurdL ? r.sCurdL + " L @ ₹" + (r.sCurdPrice || MASTER.sCurd) : ""}</td>
          <td>${r.bCurdL ? r.bCurdL + " L @ ₹" + (r.bCurdPrice || MASTER.bCurd) : ""}</td>
          <td>${r.h500L ? r.h500L + " L @ ₹" + (r.h500Price || MASTER.h500) : ""}</td>
          <td>${r.fmL ? r.fmL + " L @ ₹" + (r.fmPrice || MASTER.fm) : ""}</td>
          <td>${r.fm1lL ? r.fm1lL + " L @ ₹" + (r.fm1lPrice || MASTER.fm1l) : ""}</td>
          <td>${r.sm1lL ? r.sm1lL + " L @ ₹" + (r.sm1lPrice || MASTER.sm1l) : ""}</td>

          <td>${totalLitres}</td>
          <td>₹${amount.toFixed(0)}</td>
          <td>₹${paid.toFixed(0)}</td>
          <td class="dueCol">₹${due.toFixed(0)}</td>

          <td class="no-print">
            <button class="sendBtn" onclick="sendInvoice(${i})">Send</button>
          </td>
          <td class="no-print">
            <button class="editBtn" onclick="editRow(${i})">Edit</button>
          </td>
          <td class="no-print">
            <button class="deleteBtn" onclick="deleteRow(${i})">Delete</button>
          </td>
        `;
      } else {
        // in edit mode: show qty + per-customer price inputs + editable Paid field + show computed Due (read-only)
        const totals = computeRowTotals(r);
        tr.innerHTML = `
          <td class="nameCol"><input id="name_${i}" value="${r.name || ''}" placeholder="Name"></td>
          <td class="mobileCol"><input id="mobile_${i}" value="${r.mobile || ''}" placeholder="Mobile"></td>

          <td>
            <div class="cellStack">
              <input class="qtyInput" id="tmL_${i}" value="${r.tmL || ''}" placeholder="L">
              <span>L</span>
              <input class="priceInput" id="tmP_${i}" value="${r.tmPrice || ''}" placeholder="₹">
              <span>₹/L</span>
            </div>
          </td>

          <td>
            <div class="cellStack">
              <input class="qtyInput" id="sMilkL_${i}" value="${r.sMilkL || ''}" placeholder="L">
              <span>L</span>
              <input class="priceInput" id="sMilkP_${i}" value="${r.sMilkPrice || ''}" placeholder="₹">
              <span>₹/L</span>
            </div>
          </td>

          <td>
            <div class="cellStack">
              <input class="qtyInput" id="sCurdL_${i}" value="${r.sCurdL || ''}" placeholder="L">
              <span>L</span>
              <input class="priceInput" id="sCurdP_${i}" value="${r.sCurdPrice || ''}" placeholder="₹">
              <span>₹/L</span>
            </div>
          </td>

          <td>
            <div class="cellStack">
              <input class="qtyInput" id="bCurdL_${i}" value="${r.bCurdL || ''}" placeholder="L">
              <span>L</span>
              <input class="priceInput" id="bCurdP_${i}" value="${r.bCurdPrice || ''}" placeholder="₹">
              <span>₹/L</span>
            </div>
          </td>

          <td>
            <div class="cellStack">
              <input class="qtyInput" id="h500L_${i}" value="${r.h500L || ''}" placeholder="L">
              <span>L</span>
              <input class="priceInput" id="h500P_${i}" value="${r.h500Price || ''}" placeholder="₹">
              <span>₹/L</span>
            </div>
          </td>

          <td>
            <div class="cellStack">
              <input class="qtyInput" id="fmL_${i}" value="${r.fmL || ''}" placeholder="L">
              <span>L</span>
              <input class="priceInput" id="fmP_${i}" value="${r.fmPrice || ''}" placeholder="₹">
              <span>₹/L</span>
            </div>
          </td>

          <td>
            <div class="cellStack">
              <input class="qtyInput" id="fm1lL_${i}" value="${r.fm1lL || ''}" placeholder="L">
              <span>L</span>
              <input class="priceInput" id="fm1lP_${i}" value="${r.fm1lPrice || ''}" placeholder="₹">
              <span>₹/L</span>
            </div>
          </td>

          <td>
            <div class="cellStack">
              <input class="qtyInput" id="sm1lL_${i}" value="${r.sm1lL || ''}" placeholder="L">
              <span>L</span>
              <input class="priceInput" id="sm1lP_${i}" value="${r.sm1lPrice || ''}" placeholder="₹">
              <span>₹/L</span>
            </div>
          </td>

          <td>${totals.totalLitres}</td>
          <td>₹${totals.amount.toFixed(0)}</td>

          <td>
            <input id="paid_${i}" value="${r.paid || ''}" placeholder="Paid ₹">
            <div style="font-size:11px;color:#666;">(Edit Paid)</div>
          </td>

          <td class="dueCol">
            <input id="due_${i}" value="₹${totals.due.toFixed(0)}" readonly>
            <div style="font-size:11px;color:#666;">Prev: ₹${totals.prevDue.toFixed(0)}</div>
          </td>

          <td class="no-print">
            <button class="sendBtn" onclick="sendInvoice(${i})">Send</button>
          </td>
          <td class="no-print">
            <button class="saveBtn" onclick="saveRow(${i})">Save</button>
            <button class="cancelBtn" onclick="cancelEdit(${i})">Cancel</button>
          </td>
          <td class="no-print">
            <button class="deleteBtn" onclick="deleteRow(${i})">Delete</button>
          </td>
        `;
      }

      tbody.appendChild(tr);
    });

    // totals UI
    document.getElementById("tTM").innerText  = tTM;
    document.getElementById("tSM").innerText  = tSM;
    document.getElementById("tSC").innerText  = tSC;
    document.getElementById("tBC").innerText  = tBC;
    document.getElementById("tH5").innerText  = tH5;
    document.getElementById("tFM").innerText  = tFM;
    document.getElementById("tFM1").innerText = tFM1;
    document.getElementById("tSM1").innerText = tSM1;

    document.getElementById("tLIT").innerText =
      totalLitresSold.toFixed(2).replace(/\.00$/, "");
    document.getElementById("tMoney").innerText = totalMoney.toFixed(0);

    saveCurrentDate();
  }

  // UI bindings
  document.getElementById("addRowBtn").addEventListener("click", addRow);
  document.getElementById("pdfBtn").addEventListener("click", () => window.print());

  document.getElementById("datePicker").addEventListener("change", (e) => {
    const val = e.target.value;
    if (!val) return;
    loadDate(val);
  });

  // master save/reset
  document.getElementById("saveMaster").addEventListener("click", () => {
    const m = {
      tm:   parseFloat(document.getElementById("master_tm").value)   || DEFAULT_MASTER.tm,
      sMilk:parseFloat(document.getElementById("master_sMilk").value) || DEFAULT_MASTER.sMilk,
      sCurd:parseFloat(document.getElementById("master_sCurd").value) || DEFAULT_MASTER.sCurd,
      bCurd:parseFloat(document.getElementById("master_bCurd").value) || DEFAULT_MASTER.bCurd,
      h500: parseFloat(document.getElementById("master_h500").value)  || DEFAULT_MASTER.h500,
      fm:   parseFloat(document.getElementById("master_fm").value)   || DEFAULT_MASTER.fm,
      fm1l: parseFloat(document.getElementById("master_fm1l").value) || DEFAULT_MASTER.fm1l,
      sm1l: parseFloat(document.getElementById("master_sm1l").value) || DEFAULT_MASTER.sm1l
    };
    MASTER = m;
    saveMaster(MASTER);
    refreshMasterUI();
    render(); // re-render so UI reflects new master price usage
    alert("Master prices saved.");
  });

  document.getElementById("resetMaster").addEventListener("click", () => {
    if (!confirm("Reset master prices to defaults?")) return;
    MASTER = {...DEFAULT_MASTER};
    saveMaster(MASTER);
    refreshMasterUI();
    render();
  });

  (function init() {
    // set date to today and load
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const today = `${yyyy}-${mm}-${dd}`;
    const dp = document.getElementById("datePicker");
    dp.value = today;
    // refresh master UI (in case loaded earlier)
    MASTER = loadMaster();
    refreshMasterUI();
    loadDate(today);
  })();

</script>
</body>
</html>
